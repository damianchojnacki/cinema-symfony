<h1 align="center"><a href="https://api-platform.com"><img src="https://api-platform.com/images/logos/Logo_Circle%20webby%20text%20blue.png" alt="API Platform" width="250" height="250"></a></h1>

# Cinema (Symfony)

Cinema is a modern web application for browsing movies currently playing in theaters. The app offering a rich user experience with a seamless combination of backend and frontend technologies.

## Features

- Browse movies playing in theaters with data fetched from the TMDB API.
- Responsive and user-friendly design powered by Next.js and TailwindCSS.
- Backend API built with Symfony and API Platform.
- Component-based architecture using `@damianchojnacki/cinema` library.
- Fully containerized setup for development and production using Docker.
- Continuous Integration (CI) pipeline with GitHub Actions.

## Technologies Used

### Backend
- **PHP 8.3** with Symfony 6.
- **API Platform 4** for building a robust REST API.
- **PHPStan** and **PHPUnit** for static analysis and testing.
- **Laravel Pint** and **ESLint** for code linting.

### Frontend
- **Next.js** for server-rendered React applications.
- **TailwindCSS** for styling.
- **ESLint** for JavaScript/TypeScript linting.
- **Playwright** for end-to-end testing.
- **@damianchojnacki/cinema**: A reusable component library used across the application.

### Infrastructure
- **Docker** and **Docker Compose** for development and production environments.
- **GitHub Actions** for CI, running tests and linters.

## Project Structure

```plaintext
.
â”œâ”€â”€ api/               # Symfony backend
â”œâ”€â”€ pwa/               # Next.js frontend
â”œâ”€â”€ e2e/               # E2E tests
```

## Setup Instructions

### Prerequisites

- Docker and Docker Compose installed.

### Development

1. **Clone the repository:**
   ```bash
   git clone https://github.com/your-username/cinema.git
   cd cinema
   ```

2. **Start the development environment:**
   ```bash
   docker-compose up --build
   ```

3. **Populate the database**
   ```bash
   docker compose exec php bin/console doctrine:fixtures:load
   ```

4. **Access the application:**
    - API Docs: `http://localhost/docs`
    - App: `http://localhost`

### Testing

- **Backend tests:**
    ```bash
    docker-compose exec php bin/phpunit
    ```

- **Frontend tests:**
    ```bash
    docker run --network host -w /app -v ./e2e:/app --rm --ipc=host mcr.microsoft.com/playwright:v1.48.1-noble /bin/sh -c 'pnpm i; pnpm playwright test;'
    ```

- **Static analysis (PHPStan, ESLint):**
    ```bash
    docker-compose exec php vendor/bin/phpstan --memory-limit=2G
    docker compose exec pwa pnpm lint
    ```

### Deploying to production

1. Fill the required env:
- APP_SECRET
- CADDY_MERCURE_JWT_SECRET (must be 256 bit)
- CADDY_MERCURE_PUBLIC_URL
- CADDY_MERCURE_URL
- NEXT_PUBLIC_HOSTNAME
- POSTGRES_PASSWORD
- SERVER_NAME
- TMDB_API_KEY
- TRUSTED_HOSTS
- TRUSTED_PROXIES

The API must be accessible during frontend build, so we need to build and start backend first.

2. **Build:**
    ```bash
    docker compose -f compose.yaml -f compose.prod.yaml up -d --build --wait php && \
    docker compose -f compose.yaml -f compose.prod.yaml build pwa
    ```

3. **Start:**
    ```bash
    docker compose -f compose.yaml -f compose.prod.yaml up -d --wait
    ```

### Note for deploying on Coolify

Let's assume that url address is https://cinema-symfony.damianchojnacki.com.

1. Create new Git project and set Docker Compose option for build pack.
2. In "Domains for Php" field type https://cinema-symfony.damianchojnacki.com:80.
3. Fill Custom build command and custom start command with these from previous section.
4. Set Environment Variables:
- CADDY_MERCURE_PUBLIC_URL -> https://cinema-symfony.damianchojnacki.com
- NEXT_PUBLIC_HOSTNAME -> cinema-symfony.damianchojnacki.com
- SERVER_NAME -> http://cinema-symfony.damianchojnacki.com
- TRUSTED_HOSTS -> ^cinema-symfony.damianchojnacki.com|php$
5. Before deploy, you should stop currently running application. 
Next - find a network name in Docker Compose content generated by Coolify and
create this network manually because Coolify will not created it automatically:
    ```bash
    docker network create NETWORK_NAME
    ```
6. Deploy ðŸŽ‰

## CI/CD

The project uses GitHub Actions for automated testing and linting:

- **Backend CI Pipeline:**
    - PHPStan for static analysis.
    - PHPUnit for unit tests.
    - Laravel Pint for code linting.

- **Frontend CI Pipeline:**
    - ESLint for linting.
    - Playwright for end-to-end tests.

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.
